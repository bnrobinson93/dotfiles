#!/usr/bin/env bash

if [[ $# -eq 1 ]]; then
    selected=$1
else
    selected=$(find ~ ~/Documents ~/Documents/code ~/Documents/code/integrations-monorepo/integrations ~/Documents/code/js-lib-monorepo/libraries -mindepth 1 -maxdepth 1 -type d | fzf)
fi

if [[ -z $selected ]]; then
    exit 0
fi

selected_name=$(basename "$selected" | tr . _)
tmux_running=$(pgrep tmux)

run_nvm_check() {
    local target_dir=$1
    local session_name=$2
    
    # Create a new command that will check for .nvmrc and run nvm use if it exists
    if [[ -f "$target_dir/.nvmrc" ]]; then
        tmux send-keys -t "$session_name" "nvm use" ENTER
    fi
}

if [[ -z $TMUX ]] && [[ -z $tmux_running ]]; then
    tmux new-session -s $selected_name -c $selected
    run_nvm_check "$selected" "$selected_name"
    exit 0
fi

if ! tmux has-session -t=$selected_name 2> /dev/null; then
    tmux new-session -ds $selected_name -c $selected
    run_nvm_check "$selected" "$selected_name"
else
  run_nvm_check "$selected" "$selected_name"
fi

tmux switch-client -t $selected_name
