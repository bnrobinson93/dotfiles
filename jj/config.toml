"$schema" = "https://jj-vcs.github.io/jj/latest/config-schema.json"

[user]
name = "Brad R"
email = "31802085+bnrobinson93@users.noreply.github.com"

[revsets]
# Show: bases, current branch (limited), ALL other branch bookmarks with context, @'s immediate context
log = "bases | latest(curbranch::@, 5) | @::nextbranch | all_my_bookmark_tips | @ | @- | children(@) | ancestors(@, 2)"

[revset-aliases]
'closest_bookmark(to)' = 'heads(::to & bookmarks())'
'closest_pushable(to)' = 'heads(::to & mutable() & ~trunk() & ~description(exact:"") & (~empty() | merges()))'
'bases' = 'trunk() | present(develop) | present(feat/PEP-2386-dsp-v1-integration)'
'downstream(x,y)' = 'x::y'
'mybranches' = 'bookmarks() & mine()'
'branchesandheads' = 'mybranches | (heads(trunk()::) & mine())'
'curbranch' = 'latest(mybranches::@- & mybranches)'
'nextbranch' = 'roots(@:: & branchesandheads)'
'my_other_bookmarks' = 'mybranches & ~(curbranch::@)'
'my_other_bookmark_heads' = 'heads(my_other_bookmarks::)'
'all_my_bookmark_tips' = 'my_other_bookmarks | my_other_bookmark_heads | ancestors(my_other_bookmark_heads, 2)'

[aliases]
s = ["status"]
l = ["log", "--limit", "15"]
tug = [
  "bookmark",
  "move",
  "--from",
  "closest_bookmark(@)",
  "--to",
  "closest_pushable(@)",
]
check = ["util", "exec", "--", ".husky/pre-commit"]
push = [
  "util",
  "exec",
  "--",
  "bash",
  "-c",
  """
  if [[ -f .husky/pre-commit ]]; then
    jj check
  fi
  bookmark=$(jj log -r @ --no-graph -T 'bookmarks.join(" ")' | awk 'NR==1{gsub(/^\\*/,"",$1); gsub(/\\*$/, "", $1); print $1}')
  if [ -n "$bookmark" ]; then
    jj git push -b "$bookmark"
  else
    jj git push -c@
  fi
  """,
]

[commit]
sign = true

[ui]
default-command = [
  "log",
  "-T",
  "change_id.shortest(8) ++ ' - ' ++ label('bookmark', if(bookmarks, '(' ++ bookmarks.join(', ') ++ ') ', '')) ++ truncate_end(30, description.first_line(), '…') ++ ' ' ++ label('timestamp', '(' ++ committer.timestamp().ago() ++ ')') ++ ' ' ++ label('author', '<' ++ author.name() ++ '>') ++ ' ' ++ if(signature, label('signature', ' '), label('unsigned', ' '))",
  "--limit",
  "1",
]
diff-editor = ":builtin"

[merge-tools.nvim]
program = "nvim"
merge-args = ["-c", "DiffEditor $left $right $output"]

[colors]
signature = "blue"
unsigned = "cyan"

# this will be lazily signed again before pushing with sign-on-push; else use "own" to sign all changes
[signing]
behavior = "drop"
# Use public key directly - wrapper will use 1Password to sign
key = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOIidIqt1fDMmhx1KUyCyKduIJCcJMhQk+f5vd6JEjsO"
backend = "ssh"

[core]
excludesfile = "~/.gitignore"

[signing.backends.ssh]
# Wrapper will use local key if available, fallback to 1Password
program = "ssh-sign-wrapper.sh"
allowed_signers = "~/.ssh/allowed_signers"

[git]
sign-on-push = true
private-commits = "description(glob:'wip:*') | description(glob:'private:*')"

[templates]
git_push_bookmark = '"temp/" ++ change_id.short()'

[remotes.origin]
auto-track-bookmarks = "glob:*"
