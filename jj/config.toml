"$schema" = "https://jj-vcs.github.io/jj/latest/config-schema.json"

[user]
name = "Brad R"
email = "31802085+bnrobinson93@users.noreply.github.com"

[revsets]
log = "latest(curbranch::@, 30) | @::nextbranch | @ | @- | children(@) | ancestors(@, 3) | my_other_bookmarks | my_other_leaves | (bases & my_bookmark_ranges)"
# 1. Current bookmark: full context near @
# 2. Other bookmarks I own: only their tips + my leaves on them
# 3. Keep bases that are relevant to my work, but *only* where my stuff lives

[revset-aliases]
'closest_bookmark(to)' = 'heads(::to & bookmarks())'
'closest_pushable(to)' = 'heads(::to & mutable() & ~trunk() & ~description(exact:"") & (~empty() | merges()))'
'bases' = 'trunk() | present(develop) | present(feat/PEP-2386-dsp-v1-integration)'
'mybranches' = 'bookmarks() & mine()'
'branchesandheads' = 'mybranches | (heads(trunk()::) & mine())'
'curbranch' = 'latest(mybranches::@- & mybranches)'
'nextbranch' = 'roots(@:: & branchesandheads)'
'my_other_bookmarks' = 'mybranches & ~(curbranch::@)'
'my_other_bookmark_heads' = 'heads(my_other_bookmarks::)'
'my_leaves' = 'heads(mine() & mutable())'
'my_other_leaves' = 'my_leaves & my_other_bookmarks::'
'my_bookmark_ranges' = 'mybranches::'

[aliases]
s = ["status"]
l = ["log", "--limit", "15"]
tug- = [
  "bookmark",
  "move",
  "--from",
  "closest_bookmark(@-)",
  "--to",
  "closest_pushable(@-)",
]
tug = [
  "bookmark",
  "move",
  "--from",
  "closest_bookmark(@)",
  "--to",
  "closest_pushable(@)",
]
check = ["util", "exec", "--", ".husky/pre-commit"]
push = [
  "util",
  "exec",
  "--",
  "bash",
  "-c",
  """
  # Format files before pushing
  jj fix

  # Run pre-commit hook if it exists
  if [[ -f .husky/pre-commit ]]; then
    jj check
  fi

  # Extract bookmark and push
  bookmark=$(jj log -r @ --no-graph -T 'bookmarks.join(" ")' | awk 'NR==1{gsub(/^\\*/,"",$1); gsub(/\\*$/, "", $1); print $1}')
  if [ -n "$bookmark" ]; then
    jj git push -b "$bookmark"
  else
    jj git push -c@
  fi
  """,
]

[commit]
sign = true

[ui]
default-command = ["log", "-T", "my_default_log"]
diff-editor = ":builtin"

[merge-tools.nvim]
program = "jj-diff-nvim"
merge-args = ["-c", "DiffEditor $left $right $output"]
diff-args = ["-c", "DiffEditor $left $right"]

[colors]
signature = "blue"
unsigned = "cyan"

# this will be lazily signed again before pushing with sign-on-push; else use "own" to sign all changes
[signing]
behavior = "drop"
# Point to the public key file instead of embedding the key
key = "~/.ssh/id_ed25519_GitHubSigning.pub"
backend = "ssh"

[core]
excludesfile = "~/.gitignore"

[signing.backends.ssh]
program = "ssh-sign-wrapper.sh"
allowed_signers = "~/.ssh/allowed_signers"

[git]
sign-on-push = true
private-commits = "description(glob:'wip:*') | description(glob:'private:*')"

[templates]
git_push_bookmark = '"temp/" ++ change_id.short()'

[template-aliases]
my_default_log = "change_id.shortest(8) ++ ' - ' ++ label('bookmark', if(bookmarks, '(' ++ bookmarks.join(', ') ++ ') ', '')) ++ truncate_end(30, description.first_line(), '…') ++ ' ' ++ label('timestamp', '(' ++ committer.timestamp().ago() ++ ')') ++ ' ' ++ label('author', '<' ++ author.name() ++ '>') ++ ' ' ++ if(signature, label('signature', ' '), label('unsigned', ' '))"

[remotes.origin]
auto-track-bookmarks = "glob:*"

# Code formatting tools for jj fix
[fix.tools.gofmt]
command = ["gofmt"]
patterns = ["glob:'**/*.go'"]

[fix.tools.prettier]
command = ["pnpx", "prettier", "--stdin-filepath", "$path"]
patterns = [
  "glob:'**/*.js'",
  "glob:'**/*.jsx'",
  "glob:'**/*.ts'",
  "glob:'**/*.tsx'",
  "glob:'**/*.json'",
  "glob:'**/*.md'",
  "glob:'**/*.yaml'",
  "glob:'**/*.yml'",
  "glob:'**/*.css'",
  "glob:'**/*.scss'",
  "glob:'**/*.html'",
  "glob:'**/*.graphql'",
  "glob:'**/*.gql'",
  "glob:'**/.prettierrc'",
  "glob:'**/.prettierrc.*'",
]

[fix.tools.stylua]
command = ["stylua", "--stdin-filepath", "$path", "-"]
patterns = ["glob:'**/*.lua'"]
